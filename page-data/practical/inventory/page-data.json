{"componentChunkName":"component---src-pages-practical-inventory-index-mdx","path":"/practical/inventory/","result":{"pageContext":{"isCreatedByStatefulCreatePages":true,"frontmatter":{"title":"Inventory Micro App"},"relativePagePath":"/practical/inventory/index.mdx","titleType":"page","MdxNode":{"id":"6da1fa80-ade7-57df-9b45-46e5cd0c2e02","children":[],"parent":"20c6231e-f3ac-56b8-b9b2-61042692971d","internal":{"content":"---\ntitle: Inventory Micro App\n---\n\n<PageDescription>\n\nAn example three tier application architecture you can build and have deployed in IBM Kubernetes service or IBM Red Hat OpenShift in less than an hour using the IBM Garage for Cloud Developer Tools and Starter Kit Templates.\n\n</PageDescription>\n\n## Business Need\n\nIn this guide imagine you have completed a [Enterprise Design Thinking Workshop](https://www.ibm.com/garage/method/practices/think/enterprise-design-thinking/) and the out come is a single **Hill** defining the desired business outcomes. Use the steps below to help deliver this **Hill** quickly and to [Garage Method Best Practices](https://www.ibm.com/garage/method).\n\n## [Hills](https://www.ibm.com/garage/method/practices/think/practice_hills/)\n\n- **Who** Provide an internal web application system that can be used by distribution employees securely from each of the regional warehouses. The warehouses are linked using the public internet.\n\n- **What** Enable a secure web application that will allow the warehouse employees to gain easy access to list of product [SKU](https://en.wikipedia.org/wiki/Stock_keeping_unit) inventory levels and inventory locations.\n\n- **Wow** Make the system appealing and easy to use. Deliver it to the IBM Cloud platform in a short focused [Minimal Viable Product](https://www.ibm.com/garage/method/practices/think/practice_minimum_viable_product/). Use the latest managed container runtimes and DevOps best practices to enable post MVP feature improvements. Simulate a release to a  _Test_ environment.\n\n## [Architecture]()\n\nThe Micro App should be built using a three tier microservices architecture. Each tier will follow a clean separation of concerns. Each app component will be modelled using _Microservices_ and use a number of [polyglot](https://searchsoftwarequality.techtarget.com/definition/polyglot-programming) programming languages and frameworks. Data will be stored in IBM Cloudant and the Micro App will be secured using IBM App ID.\n\n![Architecture](images/architecture.png)\n\n## [Design]()\n\nThe Micro App should adhere to the following User Interface Design and API and Model Design.\n\n![UI Design](/images/inventory-ui-design.png)\n\n## Technical Requirements\n- The Mico App should adhere to the following technical requirements:\n\n    - Polyglot Microservices\n    - Stateless\n    - REST APIs\n    - DevOps with Continous Integration and Delivery\n    - Monitoring and Logging\n    - Code Analysis\n    - App Security\n    - Deployed to Red Hat OpenShift or IBM Kubernetes Managed Service\n    - Follow [Carbon Design System](https://www.carbondesignsystem.com/) User Experience\n\n## Guide\n\n### Inventory User Interface\n\n#### Setup\n\nGet the initial project created and register the pipeline for automated builds.\n\n1. Create a new repository from the React Starter Kit template - https://github.com/ibm-garage-cloud/template-node-react/generate\n\n2. Clone the new repository to your machine\n\n3. Update the project name in the `package.json` to match the repository\n\n4. Log into the cluster from the command-line then register the pipeline in Jenkins using `igc pipeline`\n\n#### Initial components\n\nClean up the UI Design patterns view to include only one entry for Stock Items.\nBased on the requirements of this first use case we can base the work off of \nthe TableList pattern. \n\n1. Make a copy of the `TableList` pattern component in the components folder. Rename the\nfile and the class inside to `StockItemList`\n\n2. Update UIShell.jsx\n    - Update the initial pattern name to `Stock Items`\n    - Update the SideNameMenu title to Inventory Management\n    - Remove all the patterns from the SideNavMenu and add a line to render the Stock Items menu - `this.renderSideNavItem(\"Stock Items\")`\n  \n    components/UIShell.jsx\n    ```javascript\n    class UIShell extends Component {\n      constructor(props) {\n        super(props);\n        this.state = {\n          patternName: \"Stock Items\"\n        };\n      }\n    \n      ...\n    \n      render() {\n        return (\n          <div>\n            <Header aria-label=\"IBM Platform Name\">\n              <SkipToContent />\n              <HeaderName href=\"#\" prefix=\"IBM\">\n                Garage for Cloud Catalyst\n              </HeaderName>\n            </Header>\n            <SideNav aria-label=\"Side navigation\">\n              <SideNavItems>\n                <SideNavMenu\n                  defaultExpanded\n                  icon={<Fade20 />}\n                  title=\"Inventory Management\"\n                >\n                  {this.renderSideNavItem(\"Stock Items\")}\n                </SideNavMenu>\n              </SideNavItems>\n            </SideNav>\n            <Content id=\"main-content\"><UIShellBody patternName={this.state.patternName} /></Content>\n          </div>\n        );\n      }\n    }\n    ```\n\n3. Update UIShellBody.jsx\n\n    - Remove all of the pattern values from the `components` map and add only show StockItem List\n    - Use `Stock Items` as the default pattern name when none is given\n\n    components/UIShellBody.jsx\n    ```javascript\n    class UIShellBody extends Component {\n      components = {\n        \"Stock Items\": StockItemList,\n      };\n      render() {\n        const PatternName = this.components[\n          this.props.patternName || \"Stock Items\"\n        ];\n        return (\n          <div className=\"pattern-container\">\n            <PatternName showDescription={true} />\n          </div>\n        );\n      }\n    }\n    ```\n`\n#### Update StockItemList according to the requirements\n\n1. Update the data structure for our sample data to match the UI\n\n    components/StockItemList.jsx\n    ```javascript\n    class StockItemList extends Component {\n      ...\n    \n      componentDidMount() {\n        const data = [\n          {\n            \"name\": \"Item 1\",\n            \"description\": \"The first item\",\n            \"stock\": 10,\n            \"unitPrice\": 100.0,\n            \"picture\": \"test\",\n            \"manufacturer\": \"unknown\",\n          },\n          {\n            \"name\": \"Item 2\",\n            \"description\": \"The second item\",\n            \"stock\": 15,\n            \"unitPrice\": 120.5,\n            \"picture\": \"test1\",\n            \"manufacturer\": \"Apple\",\n          },\n          {\n            \"name\": \"Item 3\",\n            \"description\": \"The third item\",\n            \"stock\": 20,\n            \"unitPrice\": 75.5,\n            \"picture\": \"test1\",\n            \"manufacturer\": \"Sony\",\n          }\n        ];\n    \n        this.setState({\n          data\n        });\n      }\n    \n      ...\n    }\n    ```\n\n2. Update the title, subtitle, and columns with values for our Stock Items view. Set the `formatters` to\nan empty object for now.\n\n    components/StockItemList.jsx\n    ```javascript\n    class StockItemList extends Component {\n      title = 'Stock Items';\n      subtitle = 'This is the current inventory of items';\n      columns = [\n        \"name\",\n        \"description\",\n        \"stock\",\n        \"unitPrice\",\n        \"picture\",\n        \"manufacturer\",\n      ];\n      formatters = {};\n     \n      ...\n    }\n    ```\n\n#### Add a mock service to get the Stock Items\n\n1. Create a directory called `services` under the client/src folder\n\n2. Create a service called `stock-item-mock.service` initially to validate the logic. Our \nStockItem service API will have a single asynchronous function at this time called `listStockItems()`\nthat returns a list of StockItems. \n\n    services/stock-item-mock.service.js\n    ```javascript\n    export class StockServiceMock {\n      async listStockItems() {\n        await timer(1000);\n    \n        return [\n          {\n            \"name\": \"Item 1\",\n            \"description\": \"The first item\",\n            \"stock\": 10,\n            \"unitPrice\": 100.0,\n            \"picture\": \"test\",\n            \"manufacturer\": \"unknown\",\n          },\n          {\n            \"name\": \"Item 2\",\n            \"description\": \"The second item\",\n            \"stock\": 15,\n            \"unitPrice\": 120.5,\n            \"picture\": \"test1\",\n            \"manufacturer\": \"Apple\",\n          },\n          {\n            \"name\": \"Item 3\",\n            \"description\": \"The third item\",\n            \"stock\": 20,\n            \"unitPrice\": 75.5,\n            \"picture\": \"test1\",\n            \"manufacturer\": \"Sony\",\n          }\n        ];\n      }\n    }\n    \n    async function timer(time) {\n      return new Promise(resolve => {\n        setTimeout(resolve, time)\n      });\n    }\n    ```\n\n3. Update the components to pass the service in the properties\n\n    App.test.jsx\n    ```javascript\n    describe('App', () => {\n      test('canary verifies test infrastructure', () => {\n         expect(true).toEqual(true);\n      });\n    \n      test('renders without crashing', () => {\n        const div = document.createElement('div');\n        ReactDOM.render(<App stockService={new StockServiceMock()}/>, div);\n        ReactDOM.unmountComponentAtNode(div);\n      });\n    });\n    ```\n\n    App.jsx\n    ```javascript\n    class App extends Component {\n      constructor(props) {\n        super(props);\n    \n        this.stockService = props.stockService || new MockStockService();\n      }\n    \n      render() {\n        return (\n          <div className=\"App\">\n            <UIShell stockService={this.stockService}/>\n          </div>\n        );\n      }\n    }\n    ```\n\n    components/UIShell.jsx\n    ```javascript\n    class UIShell extends Component {\n      ...\n      \n      <Content id=\"main-content\"><UIShellBody patternName={this.state.patternName} stockService={this.props.stockService}/></Content>\n     \n      ...\n    }\n    ```\n\n    components/UIShellBody.jsx\n    ```javascript\n    class UIShellBody extends Component {\n      components = {\n        \"Stock Items\": StockItemList,\n      };\n      render() {\n        const PatternName = this.components[\n          this.props.patternName || \"Stock Items\"\n        ];\n        return (\n          <div className=\"pattern-container\">\n            <PatternName showDescription={true} stockService={this.props.stockService} />\n          </div>\n        );\n      }\n    }\n    ```\n\n4. Update `StockItemList` to use the provided service\n\n    components/StockItemList.jsx\n    ```javascript\n    class StockItemList extends Component {\n      ...\n    \n      constructor(props) {\n        super(props);\n    \n        this.stockService = props.stockService;\n    \n        this.state = {\n          data: [],\n          selectedRow: 0\n        };\n      }\n    \n      async componentDidMount() {\n    \n        this.setState({\n          data: await this.stockService.listStockItems()\n        });\n      }\n    \n      ...\n    }\n    ```\n\n#### Add a service that calls the BFF\n\n1. Create a service implementation in the `services` directory called `stock-service.js`\n\n    services/stock-service.js\n    ```javascript\n    export class StockService {\n      async listStockItems() {\n        return [];\n      }\n    }\n    ```\n\n2. Add an implementation of listStockItems() that calls the BFF through the `/api` proxy\n\n    ```javascript\n    export class StockService {\n      constructor(baseUrl) {\n        this.baseUrl = baseUrl || '/api';\n      }\n    \n      async listStockItems() {\n        return superagent\n          .get(this.baseUrl + '/stock-items')\n          .set('accept', 'application/json')\n          .then(res => {\n            console.log('Got response: ', res);\n            return res.body || [];\n          });\n      }\n    }\n    ``` \n    \n    **Note:** In dev mode the proxy is configured in `client/package.json`. When running with the express \n    server the proxy is configured in `server/routers/api.js`. By default the value points to `localhost:3001`.\n\n3. Update `App.jsx` to use the new service instead of the mock service.\n\n    App.jsx\n    ```javascript\n    class App extends Component {\n      constructor(props) {\n        super(props);\n    \n        this.stockService = props.stockService || new StockService();\n      }\n    \n      ...\n    }\n    ```\n\n4. Configure the helm chart to point to the kubernetes Service resource of the BFF.\n\n    chart/template-node-react/values.yaml\n    ```javascript\n    apiHost: \"inventory-management-bff:80\"\n    ``` \n\n### Inventory Service\n\n#### Setup\n\nGet the initial project created and register the pipeline for automated builds.\n\n1. Create a new repository from the Java Spring Starter Kit template - https://github.com/ibm-garage-cloud/template-java-spring/generate\n\n2. Clone the new repository to your machine\n\n3. Update the project name in the `package.json` to match the repository\n\n4. Log into the cluster from the command-line then register the pipeline in Jenkins using `igc pipeline`\n\n#### Create initial components \n\n1. Copy `com.ibm.hello.app.Application` into the `com.ibm.inventory_management.app` package and\nupdate the @ComponentScan package list to include `com.ibm.inventory_management.*`\n\n    com.ibm.inventory_management.app.Application\n    ```java\n    @SpringBootApplication\n    @ComponentScan({\"com.ibm.inventory_management.*\", \"com.ibm.cloud_garage.*\",\"com.ibm.health\"})\n    public class Application extends SpringBootServletInitializer {\n        public static void main(String[] args) {\n            SpringApplication.run(Application.class, args);\n        }\n    \n        ...\n    \n        @Override\n        protected SpringApplicationBuilder configure(SpringApplicationBuilder application) {\n            return application.sources(Application.class);\n        }\n    }\n    ```\n\n2. Delete `com.ibm.hello.app.Application`\n\n#### Add StockItem controller\n\n1. Start the tests in tdd mode with `npm run tdd` (or `./gradlew test --continuous`)\n\n2. Add a StockItemControllerTest.java in `com.ibm.inventory_management.controllers` under the `test` folder\n\n    ```java\n    @DisplayName(\"StockItemController\")\n    public class StockItemControllerTest {\n    \n        @Test\n        @DisplayName(\"canary verifies test infrastructure\")\n        public void canary() {\n            Assertions.assertTrue(false);\n        }\n    }\n    ```\n\n3. Change the value to `true` to make it pass\n\n4. Add the MockMvc infrastructure and create the `StockItemController`\n\n    ```java\n    @DisplayName(\"StockItemController\")\n    public class StockItemControllerTest {\n        StockItemController controller;\n    \n        MockMvc mockMvc;\n    \n        @BeforeEach\n        public void setup() {\n            controller = spy(new StockItemController());\n    \n            mockMvc = MockMvcBuilders.standaloneSetup(controller).build();\n        }\n    \n        ...\n    }\n    ```\n\n    ```java\n    @RestController\n    public class StockItemController {\n    }\n    ```\n\n5. Add the tests for the controller behavior and make the corresponding changes to make the tests pass\n\n    ```java\n    @DisplayName(\"StockItemController\")\n    public class StockItemControllerTest {\n        ...\n    \n        @Nested\n        @DisplayName(\"Given [GET] /stock-items\")\n        public class GivenGetStockItems {\n    \n            @Test\n            @DisplayName(\"When called then it should return a 200 status\")\n            public void when_called_should_return_200_status() throws Exception {\n    \n                mockMvc.perform(get(\"/stock-items\"))\n                        .andExpect(status().isOk());\n            }\n    \n            @Test\n            @DisplayName(\"When called then it should return an empty array\")\n            public void when_called_then_return_an_empty_array() throws Exception {\n    \n                mockMvc.perform(get(\"/stock-items\").accept(\"application/json\"))\n                        .andExpect(content().json(\"[]\"));\n            }\n        }\n    }\n    ```\n\n    ```java\n    @RestController\n    public class StockItemController {\n    \n        @GetMapping(path = \"/stock-items\", produces = \"application/json\")\n        public List<StockItem> listStockItems() {\n            return new ArrayList();\n        }\n    }\n    ```\n\n#### Add a service for providing results\n\n1. Update the controller test to include returning data from the service\n\n    ```java\n    @DisplayName(\"StockItemController\")\n    public class StockItemControllerTest {\n        StockItemController controller;\n        StockItemApi service;\n    \n        MockMvc mockMvc;\n    \n        @BeforeEach\n        public void setup() {\n            service = mock(StockItemApi.class);\n    \n            controller = spy(new StockItemController(service));\n    \n            mockMvc = MockMvcBuilders.standaloneSetup(controller).build();\n        }\n        \n        @Nested\n        @DisplayName(\"Given [GET] /stock-items\")\n        public class GivenGetStockItems {\n            @Test\n            @DisplayName(\"When called then it should return a 200 status\")\n            public void when_called_should_return_200_status() throws Exception {\n    \n                mockMvc.perform(get(\"/stock-items\"))\n                        .andExpect(status().isOk());\n            }\n    \n            @Test\n            @DisplayName(\"When called then it should return the results of the StockItemService\")\n            public void when_called_then_return_the_results_of_the_stockitemservice() throws Exception {\n    \n                final List<StockItem> expectedResult = Arrays.asList(new StockItem());\n                when(service.listStockItems()).thenReturn(expectedResult);\n    \n                mockMvc.perform(get(\"/stock-items\").accept(\"application/json\"))\n                        .andExpect(content().json(\"[{}]\"));\n            }\n        }\n    }\n    ```\n\n    com.ibm.inventory_management.model.StockItem\n    ```java\n    public class StockItem implements Serializable {\n    }\n    ```\n    \n    com.ibm.inventory_management.service.StockItemApi;\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    import java.util.List;\n    \n    import com.ibm.inventory_management.model.StockItem;\n    \n    public interface StockItemApi {\n        public List<StockItem> listStockItems();\n    }\n    ```\n    \n    ```java\n    @RestController\n    public class StockItemController {\n    \n        private final StockItemApi service;\n    \n        public StockItemController(StockItemApi service) {\n            this.service = service;\n        }\n    \n        @GetMapping(path = \"/stock-items\", produces = \"application/json\")\n        public List<StockItem> listStockItems() {\n            return this.service.listStockItems();\n        }\n    }\n    ```\n\n2. Update the `StockItem` model to include the necessary fields\n\n    com.ibm.inventory_management.model.StockItem\n    ```java\n    package com.ibm.inventory_management.model;\n    \n    import java.io.Serializable;\n    \n    public class StockItem implements Serializable {\n        private String id = null;\n        private String name = null;\n        private int stock = 0;\n        private double price = 0.0;\n        private String manufacturer = \"\";\n    \n        public StockItem() {\n            super();\n        }\n    \n        public StockItem(String id) {\n            super();\n    \n            this.setId(id);\n        }\n    \n        public String getId() {\n            return id;\n        }\n    \n        public void setId(String id) {\n            this.id = id;\n        }\n    \n        public StockItem withId(String id) {\n            this.id = id;\n    \n            return this;\n        }\n    \n        public String getName() {\n            return name;\n        }\n    \n        public void setName(String name) {\n            this.name = name;\n        }\n    \n        public StockItem withName(String name) {\n            this.setName(name);\n    \n            return this;\n        }\n    \n        public int getStock() {\n            return stock;\n        }\n    \n        public void setStock(int stock) {\n            this.stock = stock;\n        }\n    \n        public StockItem withStock(int stock) {\n            this.setStock(stock);\n    \n            return this;\n        }\n    \n        public double getPrice() {\n            return price;\n        }\n    \n        public void setPrice(double price) {\n            this.price = price;\n        }\n    \n        public StockItem withPrice(double price) {\n            this.setPrice(price);\n    \n            return this;\n        }\n    \n        public String getManufacturer() {\n            return manufacturer;\n        }\n    \n        public void setManufacturer(String manufacturer) {\n            this.manufacturer = manufacturer;\n        }\n    \n        public StockItem withManufacturer(String manufacturer) {\n            this.setManufacturer(manufacturer);\n    \n            return this;\n        }\n    }\n    ```\n\n3. Provide an implementation of the service that just returns canned data, for now\n\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    import java.util.Arrays;\n    import java.util.List;\n    \n    import org.springframework.context.annotation.Primary;\n    import org.springframework.stereotype.Service;\n    \n    import com.ibm.inventory_management.model.StockItem;\n    \n    @Primary\n    @Service\n    public class StockItemService implements StockItemApi {\n        @Override\n        public List<StockItem> listStockItems() {\n            return Arrays.asList(\n                    new StockItem(\"1\")\n                            .withName(\"Item 1\")\n                            .withStock(100)\n                            .withPrice(10.5)\n                            .withManufacturer(\"Sony\"),\n                    new StockItem(\"2\")\n                            .withName(\"Item 2\")\n                            .withStock(150)\n                            .withPrice(100.0)\n                            .withManufacturer(\"Insignia\"),\n                    new StockItem(\"3\")\n                            .withName(\"Item 3\")\n                            .withStock(10)\n                            .withPrice(1000.0)\n                            .withManufacturer(\"Panasonic\")\n                    );\n        }\n    }\n    ```\n\n4. Update the swagger config to restrict the results to the `/stock-items` api\n\n    com.ibm.cloud_garage.swagger.SwaggerDocket\n    ```java\n    @Component\n    @EnableSwagger2\n    public class SwaggerDocket {\n        ...\n    \n        @Bean\n        public Docket api() {\n            return new Docket(DocumentationType.SWAGGER_2)\n                    .select()\n                    .apis(buildApiRequestHandler())\n                    .paths(PathSelectors.regex(\".*stock-item.*\"))\n                    .build()\n                    .apiInfo(buildApiInfo());\n        }    \n    }\n    ```\n\n### Inventory BFF\n\n#### Setup\n\nGet the initial project created and register the pipeline for automated builds.\n\n1. Create a new repository from the Typescript GraphQL Starter Kit template - https://github.com/ibm-garage-cloud/template-graphql-typescript/generate\n\n2. Clone the new repository to your machine\n\n3. Update the project name in the `package.json` to match the repository\n\n4. Log into the cluster from the command-line then register the pipeline in Jenkins using `igc pipeline`\n\n#### Build the controller for the REST interface\n\n1. Create the controller test\n\n    test/controllers/stock-items.controller.spec.ts\n    ```typescript\n    import {Application} from 'express';\n    import * as request from 'supertest';\n    \n    import {buildApiServer} from '../helper';\n    \n    describe('stock-item.controller', () => {\n    \n      let app: Application;\n      beforeEach(async () => {\n        const apiServer = buildApiServer();\n    \n        app = await apiServer.getApp();\n      });\n      \n      test('canary verifies test infrastructure', () => {\n         expect(true).toEqual(true);\n      });\n    \n      describe('given GET /stock-items', () => {\n        describe('when service is successful', () => {\n          test('then return 200 status', async () => {\n            return request(app).get('/stock-items').expect(200);\n          });\n    \n          test('then should return an empty array', async () => {\n            return request(app).get('/stock-items').expect([]);\n          });\n        });\n      });\n    }\n    ```\n\n    src/controllers/stock-items.controller.ts\n    ```typescript\n    import {GET, Path} from 'typescript-rest';\n    \n    @Path('stock-items')\n    export class StockItemsController {\n    \n      @GET\n      async listStockItems(): Promise<any[]> {\n        return [];\n      }\n    }\n    ```\n\n2. Add the controller to the controllers `index.ts`\n\n    ```typescript\n    export * from './stock-items.controller';\n    ```\n\n#### Update the controller to call a service\n\n1. Add a StockItem model that matches the UI model and add it to models `index.ts`\n\n    src/models/stock-item.model.ts\n    ```typescript\n    export class StockItemModel {\n      id: string;\n      name: string;\n      description: string;\n      stock: number;\n      unitPrice: number;\n      picture: string;\n      manufacturer: string;\n    }\n    ```\n\n    src/models/index.ts\n    ```typescript\n    export * from './stock-item.model';\n    ```\n\n2. Define an abstract class for the api and add it to the services `index.ts`\n\n    src/services/stock-items.api.ts\n    ```typescript\n    import {StockItemModel} from '../models';\n    \n    export abstract class StockItemsApi {\n      async abstract listStockItems(): Promise<StockItemModel[]>;\n    }\n    ```\n\n    src/services/index.ts\n    ```typescript\n    export * from './stock-items.api';\n    ```\n\n3. Update the controller test to inject the service into the controller and to return the value from the service\n\n    test/controllers/stock-items.controller.spec.ts\n    ```typescript\n    import {Application} from 'express';\n    import * as request from 'supertest';\n    import {Container} from 'typescript-ioc';\n    \n    import {buildApiServer} from '../helper';\n    import Mock = jest.Mock;\n    import {StockItemsApi} from '../../src/services';\n    \n    describe('stock-item.controller', () => {\n    \n      let app: Application;\n      let service_listStockItems: Mock;\n    \n      beforeEach(async () => {\n        service_listStockItems = jest.fn();\n        Container.bind(StockItemsApi).provider({\n          get: () => ({\n            listStockItems: service_listStockItems\n          }),\n        });\n    \n        const apiServer = buildApiServer();\n    \n        app = await apiServer.getApp();\n      });\n    \n      test('canary verifies test infrastructure', () => {\n         expect(true).toEqual(true);\n      });\n    \n      describe('given GET /stock-items', () => {\n        describe('when service is successful', () => {\n          const expectedResult = [{value: 'val'}];\n          beforeEach(() => {\n            service_listStockItems.mockResolvedValue(expectedResult);\n          });\n    \n          test('then return 200 status', async () => {\n            return request(app).get('/stock-items').expect(200);\n          });\n    \n          test('then should return value from service', async () => {\n            return request(app).get('/stock-items').expect(expectedResult);\n          });\n        });\n    \n        describe('when service fails', () => {\n          beforeEach(() => {\n            service_listStockItems.mockRejectedValue(new Error('service failed'));\n          });\n    \n          test('then return 502 error', async () => {\n            return request(app).get('/stock-items').expect(502);\n          });\n        });\n      });\n    });\n    ```\n\n4. Update the controller to inject the service and use it\n\n    src/controllers/stock-items.controller.ts\n    ```typescript\n    import {Inject} from 'typescript-ioc';\n    import {GET, Path} from 'typescript-rest';\n    import {HttpError} from 'typescript-rest/dist/server/model/errors';\n    \n    import {StockItemModel} from '../models';\n    import {StockItemsApi} from '../services';\n    \n    class BadGateway extends HttpError {\n      constructor(message?: string) {\n        super(\"BadGateway\", message);\n        this.statusCode = 502;\n      }\n    }\n    \n    @Path('stock-items')\n    export class StockItemsController {\n      @Inject\n      service: StockItemsApi;\n    \n      @GET\n      async listStockItems(): Promise<StockItemModel[]> {\n        try {\n          return await this.service.listStockItems();\n        } catch (err) {\n          throw new BadGateway('There was an error');\n        }\n      }\n    }\n    ```\n\n#### Create a mock service implementation\n\n1. Add a `stock-items-mock.service` to services and add it to `index.ts`\n\n    src/services/stock-items-mock.service.ts\n    ```typescript\n    import {Provides} from 'typescript-ioc';\n    \n    import {StockItemsApi} from './stock-items.api';\n    import {StockItemModel} from '../models';\n    \n    @Provides(StockItemsApi)\n    export class StockItemsMockService implements StockItemsApi {\n      async listStockItems(): Promise<StockItemModel[]> {\n        return [\n          {\n            id: \"1\",\n            name: \"Self-sealing stem bolt\",\n            description: \"Self-sealing stem bolt\",\n            stock: 10,\n            unitPrice: 10.5,\n            picture: \"https://via.placeholder.com/32.png\",\n            manufacturer: \"Bajor Galactic\"\n          },\n          {\n            id: \"2\",\n            name: \"Heisenberg compensator\",\n            description: \"Magical component that negates the effects of the Heisenberg Uncertainty Principle\",\n            stock: 20,\n            unitPrice: 20.0,\n            picture: \"https://via.placeholder.com/32.png\",\n            manufacturer: \"Federation Imports\"\n          },\n          {\n            id: \"3\",\n            name: \"Tooth sharpener\",\n            description: \"Industrial strength tooth sharpener\",\n            stock: 30,\n            unitPrice: 5.25,\n            picture: \"https://via.placeholder.com/32.png\",\n            manufacturer: \"Farenginar Exploits\"\n          }\n        ];\n      }\n    }\n    ```\n\n    src/services/index.ts\n    ```typescript\n    export * from './stock-items-mock.service';\n    ```\n\n2. The controller should now return the values from the mock service when invoked\n\n#### Add a GraphQL implementation of Stock Items\n\n1. Add a `stock-items` GraphQL schema and add it to the schemas `index.ts`\n\n    src/schemas/stock-item.schema.ts\n    ```typescript\n    import {Field, Float, Int, ObjectType} from 'type-graphql';\n    import {StockItemModel} from '../models';\n    \n    @ObjectType()\n    export class StockItem implements StockItemModel {\n      @Field()\n      id: string;\n      @Field()\n      description: string;\n      @Field()\n      manufacturer: string;\n      @Field()\n      name: string;\n      @Field({nullable: true})\n      picture: string;\n      @Field(type => Int)\n      stock: number;\n      @Field(type => Float)\n      unitPrice: number;\n    }\n    ``` \n\n    src/schemas/index.ts\n    ```typescript\n    export * from './stock-item.schema'\n    ```\n\n2. Add a 'stock-item' GraphQL resolver and add it to the resolvers `index.ts`\n\n    src/resolvers/stock-item.resolver.ts\n    ```typescript\n    import {Query, Resolver} from 'type-graphql';\n    import {Inject} from 'typescript-ioc';\n    \n    import {resolverManager} from './_resolver-manager';\n    import {StockItem} from '../schemas';\n    import {StockItemModel} from '../models';\n    import {StockItemsApi} from '../services';\n    \n    @Resolver(of => StockItem)\n    export class StockItemResolver {\n      @Inject\n      service: StockItemsApi;\n    \n      @Query(returns => [StockItem])\n      async stockItems(): Promise<StockItemModel[]> {\n        return this.service.listStockItems();\n      }\n    }\n    \n    resolverManager.registerResolver(StockItemResolver);\n    ```\n\n    **Note:** The Starter Kit includes a `resolverManager` component that simplifies the steps to\n    make the resolver available. All that is required to use the resolver is to register it, preferably\n    at the bottom of the module where it is defined.\n\n    src/resolvers/index.ts\n    ```typescript\n    export * from './stock-item.resolver';\n    ```\n\n3. Verify that the that the resolver is available using the Graph QL browser provided by the\nStarter Kit (visit http://{host}:{port}/ and add `query { stockItems { name } }`)\n\n#### Create a service implementation that calls the microservice\n\n1. Add a `stock-item-service` config and the class to config/index.ts\n\n    src/config/stock-item-service.config\n    ```typescript\n    import {Provided, Provider} from 'typescript-ioc';\n    \n    const baseUrl: string = process.env.SERVICE_URL || 'localhost:9080';\n    \n    const provider: Provider = {\n      get: () => ({\n        baseUrl,\n      })\n    };\n    \n    @Provided(provider)\n    export class StockItemServiceConfig {\n      baseUrl: string;\n    }\n    ```\n\n    src/config/index.ts\n    ```typescript\n    export * from './stock-item-service.config'\n    ```\n   \n2. Add `stock-items` service that uses the config\n\n    src/services/stock-items.service.ts\n    ```typescript\n    import {Inject, Provides} from 'typescript-ioc';\n    import {get, Response} from 'superagent';\n    \n    import {StockItemsApi} from './stock-items.api';\n    import {StockItemModel} from '../models';\n    import {StockItemServiceConfig} from '../config';\n    import {LoggerApi} from '../logger';\n    \n    class StockItem {\n      'id'?: string;\n      'manufacturer'?: string;\n      'name'?: string;\n      'price'?: number;\n      'stock'?: number;\n    }\n    \n    @Provides(StockItemsApi)\n    export class StockItemsService implements StockItemsApi {\n      @Inject\n      _logger: LoggerApi;\n      @Inject\n      config: StockItemServiceConfig;\n    \n      get logger(): LoggerApi {\n        return this._logger.child('StockItemsService');\n      }\n    \n      async listStockItems(): Promise<StockItemModel[]> {\n        try {\n          const response: Response = await get(this.config.baseUrl + '/stock-items')\n            .set('Accept', 'application/json');\n    \n          return this.mapStockItems(response.body);\n        } catch (err) {\n          this.logger.error('Error getting data from service', err);\n          throw err;\n        }\n      }\n    \n      mapStockItems(data: StockItem[]): StockItemModel[] {\n        return data.map(this.mapStockItem);\n      }\n    \n      mapStockItem(item: StockItem): StockItemModel {\n        return {\n          id: item.id,\n          name: item.name,\n          description: item.name,\n          stock: item.stock,\n          unitPrice: item.price,\n          picture: 'https://via.placeholder.com/32.png',\n          manufacturer: item.manufacturer,\n        };\n      }\n    }\n    ```\n\n3. Remove the `@Provides()` decorator from the mock service\n\n    src/services/stock-items-mock.service.ts\n    ```typescript\n    import {StockItemsApi} from './stock-items.api';\n    import {StockItemModel} from '../models';\n    \n    export class StockItemsMockService implements StockItemsApi {\n      ...\n    }\n    ```\n\n4. Add `stock-item.service` to `index.ts` in the service directory (`stock-items-mock.service` can be removed)\n\n    src/services/index.ts\n    ```typescript\n    export * from './stock-items.service';\n    ```\n\n5. Add `serviceUrl` to the values.yaml file of the helm chart with a value that matches the \nkubernetes service of the microservice\n\n    chart/template-graphql-typescript/values.yaml\n    ```yaml\n    global: {}\n    \n    serviceUrl: \"inventory-management-service:80\"\n    \n    ...\n    ```\n\n6. Add an environment variable in the deployment for the service url along with the other environment variables\n\n    chart/template-graphql-typescript/templates/deployment.yaml\n    ```yaml\n      ...\n      env:\n        - name: INGRESS_HOST\n          value: {{ include \"starter-kit-chart.host\" . }}\n        - name: PROTOCOLS\n          value: {{ include \"starter-kit-chart.protocols\" . }}\n        - name: SERVICE_URL\n          value: {{ .Values.serviceUrl | quote }}\n      ...\n    ```\n\n### Add a Cloudant backend to the service\n\n#### Update the gradle config to include cloudant dependencies\n\n1. Add `build-services.gradle` to the gradle folder\n\n    gradle/build-services.gradle\n    ```\n    dependencies {\n        compile group: 'com.cloudant', name: 'cloudant-client', version: '2.17.0'\n        compile group: 'com.jayway.jsonpath', name: 'json-path', version: '2.4.0'\n        compile group: 'javax.xml.bind', name: 'jaxb-api', version: '2.1'\n        compile group: 'joda-time', name: 'joda-time', version: '2.10.3'\n    }\n    ```\n\n2. Apply build-services.gradle to build.gradle\n\n    build.gradle\n    ```\n    ...\n    apply from:   'gradle/build-services.gradle'\n    ...\n    ```\n\n#### Add configuration values\n\n1. Add CloudantConfig to hold the url, username, password, and databaseName values\n\n    com.ibm.inventory_management.config.CloudantConfig\n    ```java\n    package com.ibm.inventory_management.config;\n    \n    import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n    \n    @JsonIgnoreProperties(ignoreUnknown = true)\n    public class CloudantConfig {\n        private String url;\n        private String username;\n        private String password;\n        private String databaseName;\n    \n        public String getUrl() {\n            return url;\n        }\n    \n        public void setUrl(String url) {\n            this.url = url;\n        }\n    \n        public CloudantConfig withUrl(String url) {\n            this.setUrl(url);\n    \n            return this;\n        }\n    \n        public String getUsername() {\n            return username;\n        }\n    \n        public void setUsername(String username) {\n            this.username = username;\n        }\n    \n        public CloudantConfig withUsername(String username) {\n            this.setUsername(username);\n    \n            return this;\n        }\n    \n        public String getPassword() {\n            return password;\n        }\n    \n        public void setPassword(String password) {\n            this.password = password;\n        }\n    \n        public CloudantConfig withPassword(String password) {\n            this.setPassword(password);\n    \n            return this;\n        }\n    \n        public String getDatabaseName() {\n            return databaseName;\n        }\n    \n        public void setDatabaseName(String databaseName) {\n            this.databaseName = databaseName;\n        }\n    \n        public CloudantConfig withDatabaseName(String databaseName) {\n            this.setDatabaseName(databaseName);\n    \n            return this;\n        }\n    \n        public String toString() {\n            return \"[CloudantConfig: url=\" + this.url + \", username=\" + this.username + \", name=\" + this.databaseName + \"]\";\n        }\n    }\n    ```\n\n2. Implement logic to load the configuration from the secret binding or local file\n\n    com.ibm.inventory_management.config.CloudantMapping\n    ```java\n    package com.ibm.inventory_management.config;\n    \n    import java.io.Serializable;\n    \n    import com.fasterxml.jackson.annotation.JsonProperty;\n    \n    public class CloudantMapping implements Serializable {\n        @JsonProperty(value = \"CLOUDANT_CONFIG\")\n        private String cloudantConfig;\n    \n        public String getCloudantConfig() {\n            return cloudantConfig;\n        }\n    \n        public void setCloudantConfig(String cloudantConfig) {\n            this.cloudantConfig = cloudantConfig;\n        }\n    }\n    ```\n\n    com.ibm.inventory_management.config.CloudantConfigFactory\n    ```java\n    package com.ibm.inventory_management.config;\n    \n    import java.io.IOException;\n    \n    import com.fasterxml.jackson.databind.ObjectMapper;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.stereotype.Component;\n    \n    @Component\n    public class CloudantConfigFactory {\n        @Bean\n        public CloudantConfig buildCloudantConfig() throws IOException {\n            return buildConfigFromBinding(\n                    loadCloudantConfig(),\n                    loadDatabaseName()\n            );\n        }\n    \n        protected String loadCloudantConfig() throws IOException {\n            return System.getProperty(\"CLOUDANT_CONFIG\") != null\n                    ? System.getProperty(\"CLOUDANT_CONFIG\")\n                    : loadCloudantConfigFromLocalDev();\n        }\n    \n        protected String loadCloudantConfigFromLocalDev() throws IOException {\n            final ObjectMapper mapper = new ObjectMapper();\n    \n            final CloudantMapping mappings = mapper.readValue(\n                    this.getClass().getClassLoader().getResourceAsStream(\"mappings.json\"),\n                    CloudantMapping.class\n            );\n    \n            return mappings.getCloudantConfig();\n        }\n    \n        protected String loadDatabaseName() {\n            return System.getProperty(\"DATABASE_NAME\") != null\n                    ? System.getProperty(\"DATABASE_NAME\")\n                    : \"stock-items\";\n        }\n    \n        protected CloudantConfig buildConfigFromBinding(String binding, String databaseName) throws IOException {\n            final ObjectMapper mapper = new ObjectMapper();\n    \n            return mapper.readValue(binding, CloudantConfig.class)\n                    .withDatabaseName(databaseName);\n        }\n    }\n    ```\n\n#### Set up local development\n\n1. Log into cloud.ibm.com and open the Cloudant service from the resource list\n\n2. Click on service credentials and expand the listed credentials\n\n3. Copy the json contents from the credentials into `mappings.json` under CLOUDANT_CONFIG \n\n    src/main/resources/mappings.json\n    ```\n    {\n      \"CLOUDANT_CONFIG\": \"{paste json here}\"\n    }\n    ```\n\n#### Implement the service\n\n1. Add a CloudantApi component to create the CloudantClient instance from the configuration\n\n    com.ibm.inventory_management.service.CloudServicesException\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    public class CloudServicesException extends Exception {\n        public CloudServicesException() {\n        }\n    \n        public CloudServicesException(String message) {\n            super(message);\n        }\n    \n        public CloudServicesException(String message, Throwable cause) {\n            super(message, cause);\n        }\n    \n        public CloudServicesException(Throwable cause) {\n            super(cause);\n        }\n    \n        public CloudServicesException(\n                String message,\n                Throwable cause,\n                boolean enableSuppression,\n                boolean writableStackTrace\n        ) {\n            super(message, cause, enableSuppression, writableStackTrace);\n        }\n    }\n    ```\n    \n    com.ibm.inventory_management.service.CloudantApi\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    import java.net.MalformedURLException;\n    import java.net.URL;\n    \n    import com.cloudant.client.api.ClientBuilder;\n    import com.cloudant.client.api.CloudantClient;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.stereotype.Component;\n    \n    import com.ibm.inventory_management.config.CloudantConfig;\n    \n    @Component\n    public class CloudantApi {\n        @Bean\n        public CloudantClient buildCloudant(CloudantConfig config) throws CloudServicesException {\n            System.out.println(\"Config: \" + config);\n            URL url = null;\n            try {\n                url = new URL(config.getUrl());\n            } catch (MalformedURLException e) {\n                throw new CloudServicesException(\"Invalid service URL specified\", e);\n            }\n    \n            return ClientBuilder\n                    .url(url)\n                    .username(config.getUsername())\n                    .password(config.getPassword())\n                    .build();\n        }\n    }\n    ```\n\n2. Add the service implementation\n\n    com.ibm.inventory_management.service.StockItemService\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    import java.io.IOException;\n    import java.util.List;\n    import javax.annotation.PostConstruct;\n    \n    import com.cloudant.client.api.CloudantClient;\n    import com.cloudant.client.api.Database;\n    import org.springframework.context.annotation.Primary;\n    import org.springframework.stereotype.Service;\n    \n    import com.ibm.inventory_management.config.CloudantConfig;\n    import com.ibm.inventory_management.model.StockItem;\n    \n    @Service\n    @Primary\n    public class StockItemService implements StockItemApi {\n        private CloudantConfig config;\n        private CloudantClient client;\n        private Database db = null;\n    \n        public StockItemService(CloudantConfig config, CloudantClient client) {\n            this.config = config;\n            this.client = client;\n        }\n    \n        @PostConstruct\n        public void init() {\n            db = client.database(config.getDatabaseName(), true);\n        }\n    \n        @Override\n        public List<StockItem> listStockItems() throws Exception {\n    \n            try {\n                return db.getAllDocsRequestBuilder()\n                        .includeDocs(true)\n                        .build()\n                        .getResponse()\n                        .getDocsAs(StockItem.class);\n    \n            } catch (IOException e) {\n                throw new Exception(\"\", e);\n            }\n        }\n    }\n    ```\n\n3. Remove the `@Primary` annotation from the mock service\n\n#### Add the values to the helm chart\n\n1. Update the `cloudantBinding` and `databaseName` values in values.yaml\n\n    **Note:** The cloudantBinding value should match the name of the cloudant binding secret\n\n### Enable AppId on the application\n\n#### User Interface\n\n1. Update the `values.yaml` file in the chart to set `ingress.appId.enabled=true` and to set the value for the AppId binding secret\n\n```yaml\n...\nappidBinding: \"binding-sms-test-oc-appid\"\n\ningress:\n  enabled: true\n  appid:\n    enabled: true\n    # web or app - https://cloud.ibm.com/docs/services/appid?topic=appid-kube-auth\n    requestType: web\n    ...\n```\n\n#### AppId redirect url config\n\n1. When the UI application is available, navigate to the https url. An error page should be displayed that looks like the \nfollowing:\n    ![AppId redirect error](images/appid-redirect-error.png)\n    \n2. The url for the error page will look like the following: \n\n    `https://us-south.appid.cloud.ibm.com/oauth/v4/25d16cda-8899-46fa-a5ae-9818f93dd1d3/authorization?client_id=0351c750-a3f0-4b8c-818b-d14558f9dfb9&response_type=code&redirect_uri=https://inventory-manangement-ui-dev.sms-test-oc-cluster.us-east.containers.appdomain.cloud/appid_callback&scope=appid_default`\n    \n    Get the value of the `redirect_url` parameter.\n\n3. Open the IBM Cloud resource list - `https://cloud.ibm.com/resources` \n\n4. Open the AppId instance to the `Manage Authentication` -> `Authentication Settings`\n\n    ![AppId authentication settings](images/appid-authentication-settings.png)\n\n5. Add the `redirect_url` to the web redirect URLs\n\n#### Add users to AppId\n\n1. Open the AppId instance to `Cloud Directory` -> `Users`\n\n    ![AppId cloud directory users](images/appid-cloud-directory-users.png)\n\n2. Add users\n\n## Summary\n\nYou have now completed the Micro App Guide demonstrating the _Inventory_ solution.\n\n## Solution Links\n\nIf you want to skip the guide and just get the components running, here are the solution Git Repositories. You can clone these and `igc pipeline` them to register them in the CI pipeline. The **README.md** may include additional setup for populating test data etc.\n\n<AnchorLinks>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-ui\">Inventory Management User Interface</AnchorLink>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-bff\">Inventory Management Backend for Frontend</AnchorLink>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-service\">Inventory Management Microservice</AnchorLink>\n</AnchorLinks>\n\n","type":"Mdx","contentDigest":"d1d3316f718d22c2e53caccea0a73789","counter":427,"owner":"gatsby-plugin-mdx"},"frontmatter":{"title":"Inventory Micro App"},"exports":{},"rawBody":"---\ntitle: Inventory Micro App\n---\n\n<PageDescription>\n\nAn example three tier application architecture you can build and have deployed in IBM Kubernetes service or IBM Red Hat OpenShift in less than an hour using the IBM Garage for Cloud Developer Tools and Starter Kit Templates.\n\n</PageDescription>\n\n## Business Need\n\nIn this guide imagine you have completed a [Enterprise Design Thinking Workshop](https://www.ibm.com/garage/method/practices/think/enterprise-design-thinking/) and the out come is a single **Hill** defining the desired business outcomes. Use the steps below to help deliver this **Hill** quickly and to [Garage Method Best Practices](https://www.ibm.com/garage/method).\n\n## [Hills](https://www.ibm.com/garage/method/practices/think/practice_hills/)\n\n- **Who** Provide an internal web application system that can be used by distribution employees securely from each of the regional warehouses. The warehouses are linked using the public internet.\n\n- **What** Enable a secure web application that will allow the warehouse employees to gain easy access to list of product [SKU](https://en.wikipedia.org/wiki/Stock_keeping_unit) inventory levels and inventory locations.\n\n- **Wow** Make the system appealing and easy to use. Deliver it to the IBM Cloud platform in a short focused [Minimal Viable Product](https://www.ibm.com/garage/method/practices/think/practice_minimum_viable_product/). Use the latest managed container runtimes and DevOps best practices to enable post MVP feature improvements. Simulate a release to a  _Test_ environment.\n\n## [Architecture]()\n\nThe Micro App should be built using a three tier microservices architecture. Each tier will follow a clean separation of concerns. Each app component will be modelled using _Microservices_ and use a number of [polyglot](https://searchsoftwarequality.techtarget.com/definition/polyglot-programming) programming languages and frameworks. Data will be stored in IBM Cloudant and the Micro App will be secured using IBM App ID.\n\n![Architecture](images/architecture.png)\n\n## [Design]()\n\nThe Micro App should adhere to the following User Interface Design and API and Model Design.\n\n![UI Design](/images/inventory-ui-design.png)\n\n## Technical Requirements\n- The Mico App should adhere to the following technical requirements:\n\n    - Polyglot Microservices\n    - Stateless\n    - REST APIs\n    - DevOps with Continous Integration and Delivery\n    - Monitoring and Logging\n    - Code Analysis\n    - App Security\n    - Deployed to Red Hat OpenShift or IBM Kubernetes Managed Service\n    - Follow [Carbon Design System](https://www.carbondesignsystem.com/) User Experience\n\n## Guide\n\n### Inventory User Interface\n\n#### Setup\n\nGet the initial project created and register the pipeline for automated builds.\n\n1. Create a new repository from the React Starter Kit template - https://github.com/ibm-garage-cloud/template-node-react/generate\n\n2. Clone the new repository to your machine\n\n3. Update the project name in the `package.json` to match the repository\n\n4. Log into the cluster from the command-line then register the pipeline in Jenkins using `igc pipeline`\n\n#### Initial components\n\nClean up the UI Design patterns view to include only one entry for Stock Items.\nBased on the requirements of this first use case we can base the work off of \nthe TableList pattern. \n\n1. Make a copy of the `TableList` pattern component in the components folder. Rename the\nfile and the class inside to `StockItemList`\n\n2. Update UIShell.jsx\n    - Update the initial pattern name to `Stock Items`\n    - Update the SideNameMenu title to Inventory Management\n    - Remove all the patterns from the SideNavMenu and add a line to render the Stock Items menu - `this.renderSideNavItem(\"Stock Items\")`\n  \n    components/UIShell.jsx\n    ```javascript\n    class UIShell extends Component {\n      constructor(props) {\n        super(props);\n        this.state = {\n          patternName: \"Stock Items\"\n        };\n      }\n    \n      ...\n    \n      render() {\n        return (\n          <div>\n            <Header aria-label=\"IBM Platform Name\">\n              <SkipToContent />\n              <HeaderName href=\"#\" prefix=\"IBM\">\n                Garage for Cloud Catalyst\n              </HeaderName>\n            </Header>\n            <SideNav aria-label=\"Side navigation\">\n              <SideNavItems>\n                <SideNavMenu\n                  defaultExpanded\n                  icon={<Fade20 />}\n                  title=\"Inventory Management\"\n                >\n                  {this.renderSideNavItem(\"Stock Items\")}\n                </SideNavMenu>\n              </SideNavItems>\n            </SideNav>\n            <Content id=\"main-content\"><UIShellBody patternName={this.state.patternName} /></Content>\n          </div>\n        );\n      }\n    }\n    ```\n\n3. Update UIShellBody.jsx\n\n    - Remove all of the pattern values from the `components` map and add only show StockItem List\n    - Use `Stock Items` as the default pattern name when none is given\n\n    components/UIShellBody.jsx\n    ```javascript\n    class UIShellBody extends Component {\n      components = {\n        \"Stock Items\": StockItemList,\n      };\n      render() {\n        const PatternName = this.components[\n          this.props.patternName || \"Stock Items\"\n        ];\n        return (\n          <div className=\"pattern-container\">\n            <PatternName showDescription={true} />\n          </div>\n        );\n      }\n    }\n    ```\n`\n#### Update StockItemList according to the requirements\n\n1. Update the data structure for our sample data to match the UI\n\n    components/StockItemList.jsx\n    ```javascript\n    class StockItemList extends Component {\n      ...\n    \n      componentDidMount() {\n        const data = [\n          {\n            \"name\": \"Item 1\",\n            \"description\": \"The first item\",\n            \"stock\": 10,\n            \"unitPrice\": 100.0,\n            \"picture\": \"test\",\n            \"manufacturer\": \"unknown\",\n          },\n          {\n            \"name\": \"Item 2\",\n            \"description\": \"The second item\",\n            \"stock\": 15,\n            \"unitPrice\": 120.5,\n            \"picture\": \"test1\",\n            \"manufacturer\": \"Apple\",\n          },\n          {\n            \"name\": \"Item 3\",\n            \"description\": \"The third item\",\n            \"stock\": 20,\n            \"unitPrice\": 75.5,\n            \"picture\": \"test1\",\n            \"manufacturer\": \"Sony\",\n          }\n        ];\n    \n        this.setState({\n          data\n        });\n      }\n    \n      ...\n    }\n    ```\n\n2. Update the title, subtitle, and columns with values for our Stock Items view. Set the `formatters` to\nan empty object for now.\n\n    components/StockItemList.jsx\n    ```javascript\n    class StockItemList extends Component {\n      title = 'Stock Items';\n      subtitle = 'This is the current inventory of items';\n      columns = [\n        \"name\",\n        \"description\",\n        \"stock\",\n        \"unitPrice\",\n        \"picture\",\n        \"manufacturer\",\n      ];\n      formatters = {};\n     \n      ...\n    }\n    ```\n\n#### Add a mock service to get the Stock Items\n\n1. Create a directory called `services` under the client/src folder\n\n2. Create a service called `stock-item-mock.service` initially to validate the logic. Our \nStockItem service API will have a single asynchronous function at this time called `listStockItems()`\nthat returns a list of StockItems. \n\n    services/stock-item-mock.service.js\n    ```javascript\n    export class StockServiceMock {\n      async listStockItems() {\n        await timer(1000);\n    \n        return [\n          {\n            \"name\": \"Item 1\",\n            \"description\": \"The first item\",\n            \"stock\": 10,\n            \"unitPrice\": 100.0,\n            \"picture\": \"test\",\n            \"manufacturer\": \"unknown\",\n          },\n          {\n            \"name\": \"Item 2\",\n            \"description\": \"The second item\",\n            \"stock\": 15,\n            \"unitPrice\": 120.5,\n            \"picture\": \"test1\",\n            \"manufacturer\": \"Apple\",\n          },\n          {\n            \"name\": \"Item 3\",\n            \"description\": \"The third item\",\n            \"stock\": 20,\n            \"unitPrice\": 75.5,\n            \"picture\": \"test1\",\n            \"manufacturer\": \"Sony\",\n          }\n        ];\n      }\n    }\n    \n    async function timer(time) {\n      return new Promise(resolve => {\n        setTimeout(resolve, time)\n      });\n    }\n    ```\n\n3. Update the components to pass the service in the properties\n\n    App.test.jsx\n    ```javascript\n    describe('App', () => {\n      test('canary verifies test infrastructure', () => {\n         expect(true).toEqual(true);\n      });\n    \n      test('renders without crashing', () => {\n        const div = document.createElement('div');\n        ReactDOM.render(<App stockService={new StockServiceMock()}/>, div);\n        ReactDOM.unmountComponentAtNode(div);\n      });\n    });\n    ```\n\n    App.jsx\n    ```javascript\n    class App extends Component {\n      constructor(props) {\n        super(props);\n    \n        this.stockService = props.stockService || new MockStockService();\n      }\n    \n      render() {\n        return (\n          <div className=\"App\">\n            <UIShell stockService={this.stockService}/>\n          </div>\n        );\n      }\n    }\n    ```\n\n    components/UIShell.jsx\n    ```javascript\n    class UIShell extends Component {\n      ...\n      \n      <Content id=\"main-content\"><UIShellBody patternName={this.state.patternName} stockService={this.props.stockService}/></Content>\n     \n      ...\n    }\n    ```\n\n    components/UIShellBody.jsx\n    ```javascript\n    class UIShellBody extends Component {\n      components = {\n        \"Stock Items\": StockItemList,\n      };\n      render() {\n        const PatternName = this.components[\n          this.props.patternName || \"Stock Items\"\n        ];\n        return (\n          <div className=\"pattern-container\">\n            <PatternName showDescription={true} stockService={this.props.stockService} />\n          </div>\n        );\n      }\n    }\n    ```\n\n4. Update `StockItemList` to use the provided service\n\n    components/StockItemList.jsx\n    ```javascript\n    class StockItemList extends Component {\n      ...\n    \n      constructor(props) {\n        super(props);\n    \n        this.stockService = props.stockService;\n    \n        this.state = {\n          data: [],\n          selectedRow: 0\n        };\n      }\n    \n      async componentDidMount() {\n    \n        this.setState({\n          data: await this.stockService.listStockItems()\n        });\n      }\n    \n      ...\n    }\n    ```\n\n#### Add a service that calls the BFF\n\n1. Create a service implementation in the `services` directory called `stock-service.js`\n\n    services/stock-service.js\n    ```javascript\n    export class StockService {\n      async listStockItems() {\n        return [];\n      }\n    }\n    ```\n\n2. Add an implementation of listStockItems() that calls the BFF through the `/api` proxy\n\n    ```javascript\n    export class StockService {\n      constructor(baseUrl) {\n        this.baseUrl = baseUrl || '/api';\n      }\n    \n      async listStockItems() {\n        return superagent\n          .get(this.baseUrl + '/stock-items')\n          .set('accept', 'application/json')\n          .then(res => {\n            console.log('Got response: ', res);\n            return res.body || [];\n          });\n      }\n    }\n    ``` \n    \n    **Note:** In dev mode the proxy is configured in `client/package.json`. When running with the express \n    server the proxy is configured in `server/routers/api.js`. By default the value points to `localhost:3001`.\n\n3. Update `App.jsx` to use the new service instead of the mock service.\n\n    App.jsx\n    ```javascript\n    class App extends Component {\n      constructor(props) {\n        super(props);\n    \n        this.stockService = props.stockService || new StockService();\n      }\n    \n      ...\n    }\n    ```\n\n4. Configure the helm chart to point to the kubernetes Service resource of the BFF.\n\n    chart/template-node-react/values.yaml\n    ```javascript\n    apiHost: \"inventory-management-bff:80\"\n    ``` \n\n### Inventory Service\n\n#### Setup\n\nGet the initial project created and register the pipeline for automated builds.\n\n1. Create a new repository from the Java Spring Starter Kit template - https://github.com/ibm-garage-cloud/template-java-spring/generate\n\n2. Clone the new repository to your machine\n\n3. Update the project name in the `package.json` to match the repository\n\n4. Log into the cluster from the command-line then register the pipeline in Jenkins using `igc pipeline`\n\n#### Create initial components \n\n1. Copy `com.ibm.hello.app.Application` into the `com.ibm.inventory_management.app` package and\nupdate the @ComponentScan package list to include `com.ibm.inventory_management.*`\n\n    com.ibm.inventory_management.app.Application\n    ```java\n    @SpringBootApplication\n    @ComponentScan({\"com.ibm.inventory_management.*\", \"com.ibm.cloud_garage.*\",\"com.ibm.health\"})\n    public class Application extends SpringBootServletInitializer {\n        public static void main(String[] args) {\n            SpringApplication.run(Application.class, args);\n        }\n    \n        ...\n    \n        @Override\n        protected SpringApplicationBuilder configure(SpringApplicationBuilder application) {\n            return application.sources(Application.class);\n        }\n    }\n    ```\n\n2. Delete `com.ibm.hello.app.Application`\n\n#### Add StockItem controller\n\n1. Start the tests in tdd mode with `npm run tdd` (or `./gradlew test --continuous`)\n\n2. Add a StockItemControllerTest.java in `com.ibm.inventory_management.controllers` under the `test` folder\n\n    ```java\n    @DisplayName(\"StockItemController\")\n    public class StockItemControllerTest {\n    \n        @Test\n        @DisplayName(\"canary verifies test infrastructure\")\n        public void canary() {\n            Assertions.assertTrue(false);\n        }\n    }\n    ```\n\n3. Change the value to `true` to make it pass\n\n4. Add the MockMvc infrastructure and create the `StockItemController`\n\n    ```java\n    @DisplayName(\"StockItemController\")\n    public class StockItemControllerTest {\n        StockItemController controller;\n    \n        MockMvc mockMvc;\n    \n        @BeforeEach\n        public void setup() {\n            controller = spy(new StockItemController());\n    \n            mockMvc = MockMvcBuilders.standaloneSetup(controller).build();\n        }\n    \n        ...\n    }\n    ```\n\n    ```java\n    @RestController\n    public class StockItemController {\n    }\n    ```\n\n5. Add the tests for the controller behavior and make the corresponding changes to make the tests pass\n\n    ```java\n    @DisplayName(\"StockItemController\")\n    public class StockItemControllerTest {\n        ...\n    \n        @Nested\n        @DisplayName(\"Given [GET] /stock-items\")\n        public class GivenGetStockItems {\n    \n            @Test\n            @DisplayName(\"When called then it should return a 200 status\")\n            public void when_called_should_return_200_status() throws Exception {\n    \n                mockMvc.perform(get(\"/stock-items\"))\n                        .andExpect(status().isOk());\n            }\n    \n            @Test\n            @DisplayName(\"When called then it should return an empty array\")\n            public void when_called_then_return_an_empty_array() throws Exception {\n    \n                mockMvc.perform(get(\"/stock-items\").accept(\"application/json\"))\n                        .andExpect(content().json(\"[]\"));\n            }\n        }\n    }\n    ```\n\n    ```java\n    @RestController\n    public class StockItemController {\n    \n        @GetMapping(path = \"/stock-items\", produces = \"application/json\")\n        public List<StockItem> listStockItems() {\n            return new ArrayList();\n        }\n    }\n    ```\n\n#### Add a service for providing results\n\n1. Update the controller test to include returning data from the service\n\n    ```java\n    @DisplayName(\"StockItemController\")\n    public class StockItemControllerTest {\n        StockItemController controller;\n        StockItemApi service;\n    \n        MockMvc mockMvc;\n    \n        @BeforeEach\n        public void setup() {\n            service = mock(StockItemApi.class);\n    \n            controller = spy(new StockItemController(service));\n    \n            mockMvc = MockMvcBuilders.standaloneSetup(controller).build();\n        }\n        \n        @Nested\n        @DisplayName(\"Given [GET] /stock-items\")\n        public class GivenGetStockItems {\n            @Test\n            @DisplayName(\"When called then it should return a 200 status\")\n            public void when_called_should_return_200_status() throws Exception {\n    \n                mockMvc.perform(get(\"/stock-items\"))\n                        .andExpect(status().isOk());\n            }\n    \n            @Test\n            @DisplayName(\"When called then it should return the results of the StockItemService\")\n            public void when_called_then_return_the_results_of_the_stockitemservice() throws Exception {\n    \n                final List<StockItem> expectedResult = Arrays.asList(new StockItem());\n                when(service.listStockItems()).thenReturn(expectedResult);\n    \n                mockMvc.perform(get(\"/stock-items\").accept(\"application/json\"))\n                        .andExpect(content().json(\"[{}]\"));\n            }\n        }\n    }\n    ```\n\n    com.ibm.inventory_management.model.StockItem\n    ```java\n    public class StockItem implements Serializable {\n    }\n    ```\n    \n    com.ibm.inventory_management.service.StockItemApi;\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    import java.util.List;\n    \n    import com.ibm.inventory_management.model.StockItem;\n    \n    public interface StockItemApi {\n        public List<StockItem> listStockItems();\n    }\n    ```\n    \n    ```java\n    @RestController\n    public class StockItemController {\n    \n        private final StockItemApi service;\n    \n        public StockItemController(StockItemApi service) {\n            this.service = service;\n        }\n    \n        @GetMapping(path = \"/stock-items\", produces = \"application/json\")\n        public List<StockItem> listStockItems() {\n            return this.service.listStockItems();\n        }\n    }\n    ```\n\n2. Update the `StockItem` model to include the necessary fields\n\n    com.ibm.inventory_management.model.StockItem\n    ```java\n    package com.ibm.inventory_management.model;\n    \n    import java.io.Serializable;\n    \n    public class StockItem implements Serializable {\n        private String id = null;\n        private String name = null;\n        private int stock = 0;\n        private double price = 0.0;\n        private String manufacturer = \"\";\n    \n        public StockItem() {\n            super();\n        }\n    \n        public StockItem(String id) {\n            super();\n    \n            this.setId(id);\n        }\n    \n        public String getId() {\n            return id;\n        }\n    \n        public void setId(String id) {\n            this.id = id;\n        }\n    \n        public StockItem withId(String id) {\n            this.id = id;\n    \n            return this;\n        }\n    \n        public String getName() {\n            return name;\n        }\n    \n        public void setName(String name) {\n            this.name = name;\n        }\n    \n        public StockItem withName(String name) {\n            this.setName(name);\n    \n            return this;\n        }\n    \n        public int getStock() {\n            return stock;\n        }\n    \n        public void setStock(int stock) {\n            this.stock = stock;\n        }\n    \n        public StockItem withStock(int stock) {\n            this.setStock(stock);\n    \n            return this;\n        }\n    \n        public double getPrice() {\n            return price;\n        }\n    \n        public void setPrice(double price) {\n            this.price = price;\n        }\n    \n        public StockItem withPrice(double price) {\n            this.setPrice(price);\n    \n            return this;\n        }\n    \n        public String getManufacturer() {\n            return manufacturer;\n        }\n    \n        public void setManufacturer(String manufacturer) {\n            this.manufacturer = manufacturer;\n        }\n    \n        public StockItem withManufacturer(String manufacturer) {\n            this.setManufacturer(manufacturer);\n    \n            return this;\n        }\n    }\n    ```\n\n3. Provide an implementation of the service that just returns canned data, for now\n\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    import java.util.Arrays;\n    import java.util.List;\n    \n    import org.springframework.context.annotation.Primary;\n    import org.springframework.stereotype.Service;\n    \n    import com.ibm.inventory_management.model.StockItem;\n    \n    @Primary\n    @Service\n    public class StockItemService implements StockItemApi {\n        @Override\n        public List<StockItem> listStockItems() {\n            return Arrays.asList(\n                    new StockItem(\"1\")\n                            .withName(\"Item 1\")\n                            .withStock(100)\n                            .withPrice(10.5)\n                            .withManufacturer(\"Sony\"),\n                    new StockItem(\"2\")\n                            .withName(\"Item 2\")\n                            .withStock(150)\n                            .withPrice(100.0)\n                            .withManufacturer(\"Insignia\"),\n                    new StockItem(\"3\")\n                            .withName(\"Item 3\")\n                            .withStock(10)\n                            .withPrice(1000.0)\n                            .withManufacturer(\"Panasonic\")\n                    );\n        }\n    }\n    ```\n\n4. Update the swagger config to restrict the results to the `/stock-items` api\n\n    com.ibm.cloud_garage.swagger.SwaggerDocket\n    ```java\n    @Component\n    @EnableSwagger2\n    public class SwaggerDocket {\n        ...\n    \n        @Bean\n        public Docket api() {\n            return new Docket(DocumentationType.SWAGGER_2)\n                    .select()\n                    .apis(buildApiRequestHandler())\n                    .paths(PathSelectors.regex(\".*stock-item.*\"))\n                    .build()\n                    .apiInfo(buildApiInfo());\n        }    \n    }\n    ```\n\n### Inventory BFF\n\n#### Setup\n\nGet the initial project created and register the pipeline for automated builds.\n\n1. Create a new repository from the Typescript GraphQL Starter Kit template - https://github.com/ibm-garage-cloud/template-graphql-typescript/generate\n\n2. Clone the new repository to your machine\n\n3. Update the project name in the `package.json` to match the repository\n\n4. Log into the cluster from the command-line then register the pipeline in Jenkins using `igc pipeline`\n\n#### Build the controller for the REST interface\n\n1. Create the controller test\n\n    test/controllers/stock-items.controller.spec.ts\n    ```typescript\n    import {Application} from 'express';\n    import * as request from 'supertest';\n    \n    import {buildApiServer} from '../helper';\n    \n    describe('stock-item.controller', () => {\n    \n      let app: Application;\n      beforeEach(async () => {\n        const apiServer = buildApiServer();\n    \n        app = await apiServer.getApp();\n      });\n      \n      test('canary verifies test infrastructure', () => {\n         expect(true).toEqual(true);\n      });\n    \n      describe('given GET /stock-items', () => {\n        describe('when service is successful', () => {\n          test('then return 200 status', async () => {\n            return request(app).get('/stock-items').expect(200);\n          });\n    \n          test('then should return an empty array', async () => {\n            return request(app).get('/stock-items').expect([]);\n          });\n        });\n      });\n    }\n    ```\n\n    src/controllers/stock-items.controller.ts\n    ```typescript\n    import {GET, Path} from 'typescript-rest';\n    \n    @Path('stock-items')\n    export class StockItemsController {\n    \n      @GET\n      async listStockItems(): Promise<any[]> {\n        return [];\n      }\n    }\n    ```\n\n2. Add the controller to the controllers `index.ts`\n\n    ```typescript\n    export * from './stock-items.controller';\n    ```\n\n#### Update the controller to call a service\n\n1. Add a StockItem model that matches the UI model and add it to models `index.ts`\n\n    src/models/stock-item.model.ts\n    ```typescript\n    export class StockItemModel {\n      id: string;\n      name: string;\n      description: string;\n      stock: number;\n      unitPrice: number;\n      picture: string;\n      manufacturer: string;\n    }\n    ```\n\n    src/models/index.ts\n    ```typescript\n    export * from './stock-item.model';\n    ```\n\n2. Define an abstract class for the api and add it to the services `index.ts`\n\n    src/services/stock-items.api.ts\n    ```typescript\n    import {StockItemModel} from '../models';\n    \n    export abstract class StockItemsApi {\n      async abstract listStockItems(): Promise<StockItemModel[]>;\n    }\n    ```\n\n    src/services/index.ts\n    ```typescript\n    export * from './stock-items.api';\n    ```\n\n3. Update the controller test to inject the service into the controller and to return the value from the service\n\n    test/controllers/stock-items.controller.spec.ts\n    ```typescript\n    import {Application} from 'express';\n    import * as request from 'supertest';\n    import {Container} from 'typescript-ioc';\n    \n    import {buildApiServer} from '../helper';\n    import Mock = jest.Mock;\n    import {StockItemsApi} from '../../src/services';\n    \n    describe('stock-item.controller', () => {\n    \n      let app: Application;\n      let service_listStockItems: Mock;\n    \n      beforeEach(async () => {\n        service_listStockItems = jest.fn();\n        Container.bind(StockItemsApi).provider({\n          get: () => ({\n            listStockItems: service_listStockItems\n          }),\n        });\n    \n        const apiServer = buildApiServer();\n    \n        app = await apiServer.getApp();\n      });\n    \n      test('canary verifies test infrastructure', () => {\n         expect(true).toEqual(true);\n      });\n    \n      describe('given GET /stock-items', () => {\n        describe('when service is successful', () => {\n          const expectedResult = [{value: 'val'}];\n          beforeEach(() => {\n            service_listStockItems.mockResolvedValue(expectedResult);\n          });\n    \n          test('then return 200 status', async () => {\n            return request(app).get('/stock-items').expect(200);\n          });\n    \n          test('then should return value from service', async () => {\n            return request(app).get('/stock-items').expect(expectedResult);\n          });\n        });\n    \n        describe('when service fails', () => {\n          beforeEach(() => {\n            service_listStockItems.mockRejectedValue(new Error('service failed'));\n          });\n    \n          test('then return 502 error', async () => {\n            return request(app).get('/stock-items').expect(502);\n          });\n        });\n      });\n    });\n    ```\n\n4. Update the controller to inject the service and use it\n\n    src/controllers/stock-items.controller.ts\n    ```typescript\n    import {Inject} from 'typescript-ioc';\n    import {GET, Path} from 'typescript-rest';\n    import {HttpError} from 'typescript-rest/dist/server/model/errors';\n    \n    import {StockItemModel} from '../models';\n    import {StockItemsApi} from '../services';\n    \n    class BadGateway extends HttpError {\n      constructor(message?: string) {\n        super(\"BadGateway\", message);\n        this.statusCode = 502;\n      }\n    }\n    \n    @Path('stock-items')\n    export class StockItemsController {\n      @Inject\n      service: StockItemsApi;\n    \n      @GET\n      async listStockItems(): Promise<StockItemModel[]> {\n        try {\n          return await this.service.listStockItems();\n        } catch (err) {\n          throw new BadGateway('There was an error');\n        }\n      }\n    }\n    ```\n\n#### Create a mock service implementation\n\n1. Add a `stock-items-mock.service` to services and add it to `index.ts`\n\n    src/services/stock-items-mock.service.ts\n    ```typescript\n    import {Provides} from 'typescript-ioc';\n    \n    import {StockItemsApi} from './stock-items.api';\n    import {StockItemModel} from '../models';\n    \n    @Provides(StockItemsApi)\n    export class StockItemsMockService implements StockItemsApi {\n      async listStockItems(): Promise<StockItemModel[]> {\n        return [\n          {\n            id: \"1\",\n            name: \"Self-sealing stem bolt\",\n            description: \"Self-sealing stem bolt\",\n            stock: 10,\n            unitPrice: 10.5,\n            picture: \"https://via.placeholder.com/32.png\",\n            manufacturer: \"Bajor Galactic\"\n          },\n          {\n            id: \"2\",\n            name: \"Heisenberg compensator\",\n            description: \"Magical component that negates the effects of the Heisenberg Uncertainty Principle\",\n            stock: 20,\n            unitPrice: 20.0,\n            picture: \"https://via.placeholder.com/32.png\",\n            manufacturer: \"Federation Imports\"\n          },\n          {\n            id: \"3\",\n            name: \"Tooth sharpener\",\n            description: \"Industrial strength tooth sharpener\",\n            stock: 30,\n            unitPrice: 5.25,\n            picture: \"https://via.placeholder.com/32.png\",\n            manufacturer: \"Farenginar Exploits\"\n          }\n        ];\n      }\n    }\n    ```\n\n    src/services/index.ts\n    ```typescript\n    export * from './stock-items-mock.service';\n    ```\n\n2. The controller should now return the values from the mock service when invoked\n\n#### Add a GraphQL implementation of Stock Items\n\n1. Add a `stock-items` GraphQL schema and add it to the schemas `index.ts`\n\n    src/schemas/stock-item.schema.ts\n    ```typescript\n    import {Field, Float, Int, ObjectType} from 'type-graphql';\n    import {StockItemModel} from '../models';\n    \n    @ObjectType()\n    export class StockItem implements StockItemModel {\n      @Field()\n      id: string;\n      @Field()\n      description: string;\n      @Field()\n      manufacturer: string;\n      @Field()\n      name: string;\n      @Field({nullable: true})\n      picture: string;\n      @Field(type => Int)\n      stock: number;\n      @Field(type => Float)\n      unitPrice: number;\n    }\n    ``` \n\n    src/schemas/index.ts\n    ```typescript\n    export * from './stock-item.schema'\n    ```\n\n2. Add a 'stock-item' GraphQL resolver and add it to the resolvers `index.ts`\n\n    src/resolvers/stock-item.resolver.ts\n    ```typescript\n    import {Query, Resolver} from 'type-graphql';\n    import {Inject} from 'typescript-ioc';\n    \n    import {resolverManager} from './_resolver-manager';\n    import {StockItem} from '../schemas';\n    import {StockItemModel} from '../models';\n    import {StockItemsApi} from '../services';\n    \n    @Resolver(of => StockItem)\n    export class StockItemResolver {\n      @Inject\n      service: StockItemsApi;\n    \n      @Query(returns => [StockItem])\n      async stockItems(): Promise<StockItemModel[]> {\n        return this.service.listStockItems();\n      }\n    }\n    \n    resolverManager.registerResolver(StockItemResolver);\n    ```\n\n    **Note:** The Starter Kit includes a `resolverManager` component that simplifies the steps to\n    make the resolver available. All that is required to use the resolver is to register it, preferably\n    at the bottom of the module where it is defined.\n\n    src/resolvers/index.ts\n    ```typescript\n    export * from './stock-item.resolver';\n    ```\n\n3. Verify that the that the resolver is available using the Graph QL browser provided by the\nStarter Kit (visit http://{host}:{port}/ and add `query { stockItems { name } }`)\n\n#### Create a service implementation that calls the microservice\n\n1. Add a `stock-item-service` config and the class to config/index.ts\n\n    src/config/stock-item-service.config\n    ```typescript\n    import {Provided, Provider} from 'typescript-ioc';\n    \n    const baseUrl: string = process.env.SERVICE_URL || 'localhost:9080';\n    \n    const provider: Provider = {\n      get: () => ({\n        baseUrl,\n      })\n    };\n    \n    @Provided(provider)\n    export class StockItemServiceConfig {\n      baseUrl: string;\n    }\n    ```\n\n    src/config/index.ts\n    ```typescript\n    export * from './stock-item-service.config'\n    ```\n   \n2. Add `stock-items` service that uses the config\n\n    src/services/stock-items.service.ts\n    ```typescript\n    import {Inject, Provides} from 'typescript-ioc';\n    import {get, Response} from 'superagent';\n    \n    import {StockItemsApi} from './stock-items.api';\n    import {StockItemModel} from '../models';\n    import {StockItemServiceConfig} from '../config';\n    import {LoggerApi} from '../logger';\n    \n    class StockItem {\n      'id'?: string;\n      'manufacturer'?: string;\n      'name'?: string;\n      'price'?: number;\n      'stock'?: number;\n    }\n    \n    @Provides(StockItemsApi)\n    export class StockItemsService implements StockItemsApi {\n      @Inject\n      _logger: LoggerApi;\n      @Inject\n      config: StockItemServiceConfig;\n    \n      get logger(): LoggerApi {\n        return this._logger.child('StockItemsService');\n      }\n    \n      async listStockItems(): Promise<StockItemModel[]> {\n        try {\n          const response: Response = await get(this.config.baseUrl + '/stock-items')\n            .set('Accept', 'application/json');\n    \n          return this.mapStockItems(response.body);\n        } catch (err) {\n          this.logger.error('Error getting data from service', err);\n          throw err;\n        }\n      }\n    \n      mapStockItems(data: StockItem[]): StockItemModel[] {\n        return data.map(this.mapStockItem);\n      }\n    \n      mapStockItem(item: StockItem): StockItemModel {\n        return {\n          id: item.id,\n          name: item.name,\n          description: item.name,\n          stock: item.stock,\n          unitPrice: item.price,\n          picture: 'https://via.placeholder.com/32.png',\n          manufacturer: item.manufacturer,\n        };\n      }\n    }\n    ```\n\n3. Remove the `@Provides()` decorator from the mock service\n\n    src/services/stock-items-mock.service.ts\n    ```typescript\n    import {StockItemsApi} from './stock-items.api';\n    import {StockItemModel} from '../models';\n    \n    export class StockItemsMockService implements StockItemsApi {\n      ...\n    }\n    ```\n\n4. Add `stock-item.service` to `index.ts` in the service directory (`stock-items-mock.service` can be removed)\n\n    src/services/index.ts\n    ```typescript\n    export * from './stock-items.service';\n    ```\n\n5. Add `serviceUrl` to the values.yaml file of the helm chart with a value that matches the \nkubernetes service of the microservice\n\n    chart/template-graphql-typescript/values.yaml\n    ```yaml\n    global: {}\n    \n    serviceUrl: \"inventory-management-service:80\"\n    \n    ...\n    ```\n\n6. Add an environment variable in the deployment for the service url along with the other environment variables\n\n    chart/template-graphql-typescript/templates/deployment.yaml\n    ```yaml\n      ...\n      env:\n        - name: INGRESS_HOST\n          value: {{ include \"starter-kit-chart.host\" . }}\n        - name: PROTOCOLS\n          value: {{ include \"starter-kit-chart.protocols\" . }}\n        - name: SERVICE_URL\n          value: {{ .Values.serviceUrl | quote }}\n      ...\n    ```\n\n### Add a Cloudant backend to the service\n\n#### Update the gradle config to include cloudant dependencies\n\n1. Add `build-services.gradle` to the gradle folder\n\n    gradle/build-services.gradle\n    ```\n    dependencies {\n        compile group: 'com.cloudant', name: 'cloudant-client', version: '2.17.0'\n        compile group: 'com.jayway.jsonpath', name: 'json-path', version: '2.4.0'\n        compile group: 'javax.xml.bind', name: 'jaxb-api', version: '2.1'\n        compile group: 'joda-time', name: 'joda-time', version: '2.10.3'\n    }\n    ```\n\n2. Apply build-services.gradle to build.gradle\n\n    build.gradle\n    ```\n    ...\n    apply from:   'gradle/build-services.gradle'\n    ...\n    ```\n\n#### Add configuration values\n\n1. Add CloudantConfig to hold the url, username, password, and databaseName values\n\n    com.ibm.inventory_management.config.CloudantConfig\n    ```java\n    package com.ibm.inventory_management.config;\n    \n    import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n    \n    @JsonIgnoreProperties(ignoreUnknown = true)\n    public class CloudantConfig {\n        private String url;\n        private String username;\n        private String password;\n        private String databaseName;\n    \n        public String getUrl() {\n            return url;\n        }\n    \n        public void setUrl(String url) {\n            this.url = url;\n        }\n    \n        public CloudantConfig withUrl(String url) {\n            this.setUrl(url);\n    \n            return this;\n        }\n    \n        public String getUsername() {\n            return username;\n        }\n    \n        public void setUsername(String username) {\n            this.username = username;\n        }\n    \n        public CloudantConfig withUsername(String username) {\n            this.setUsername(username);\n    \n            return this;\n        }\n    \n        public String getPassword() {\n            return password;\n        }\n    \n        public void setPassword(String password) {\n            this.password = password;\n        }\n    \n        public CloudantConfig withPassword(String password) {\n            this.setPassword(password);\n    \n            return this;\n        }\n    \n        public String getDatabaseName() {\n            return databaseName;\n        }\n    \n        public void setDatabaseName(String databaseName) {\n            this.databaseName = databaseName;\n        }\n    \n        public CloudantConfig withDatabaseName(String databaseName) {\n            this.setDatabaseName(databaseName);\n    \n            return this;\n        }\n    \n        public String toString() {\n            return \"[CloudantConfig: url=\" + this.url + \", username=\" + this.username + \", name=\" + this.databaseName + \"]\";\n        }\n    }\n    ```\n\n2. Implement logic to load the configuration from the secret binding or local file\n\n    com.ibm.inventory_management.config.CloudantMapping\n    ```java\n    package com.ibm.inventory_management.config;\n    \n    import java.io.Serializable;\n    \n    import com.fasterxml.jackson.annotation.JsonProperty;\n    \n    public class CloudantMapping implements Serializable {\n        @JsonProperty(value = \"CLOUDANT_CONFIG\")\n        private String cloudantConfig;\n    \n        public String getCloudantConfig() {\n            return cloudantConfig;\n        }\n    \n        public void setCloudantConfig(String cloudantConfig) {\n            this.cloudantConfig = cloudantConfig;\n        }\n    }\n    ```\n\n    com.ibm.inventory_management.config.CloudantConfigFactory\n    ```java\n    package com.ibm.inventory_management.config;\n    \n    import java.io.IOException;\n    \n    import com.fasterxml.jackson.databind.ObjectMapper;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.stereotype.Component;\n    \n    @Component\n    public class CloudantConfigFactory {\n        @Bean\n        public CloudantConfig buildCloudantConfig() throws IOException {\n            return buildConfigFromBinding(\n                    loadCloudantConfig(),\n                    loadDatabaseName()\n            );\n        }\n    \n        protected String loadCloudantConfig() throws IOException {\n            return System.getProperty(\"CLOUDANT_CONFIG\") != null\n                    ? System.getProperty(\"CLOUDANT_CONFIG\")\n                    : loadCloudantConfigFromLocalDev();\n        }\n    \n        protected String loadCloudantConfigFromLocalDev() throws IOException {\n            final ObjectMapper mapper = new ObjectMapper();\n    \n            final CloudantMapping mappings = mapper.readValue(\n                    this.getClass().getClassLoader().getResourceAsStream(\"mappings.json\"),\n                    CloudantMapping.class\n            );\n    \n            return mappings.getCloudantConfig();\n        }\n    \n        protected String loadDatabaseName() {\n            return System.getProperty(\"DATABASE_NAME\") != null\n                    ? System.getProperty(\"DATABASE_NAME\")\n                    : \"stock-items\";\n        }\n    \n        protected CloudantConfig buildConfigFromBinding(String binding, String databaseName) throws IOException {\n            final ObjectMapper mapper = new ObjectMapper();\n    \n            return mapper.readValue(binding, CloudantConfig.class)\n                    .withDatabaseName(databaseName);\n        }\n    }\n    ```\n\n#### Set up local development\n\n1. Log into cloud.ibm.com and open the Cloudant service from the resource list\n\n2. Click on service credentials and expand the listed credentials\n\n3. Copy the json contents from the credentials into `mappings.json` under CLOUDANT_CONFIG \n\n    src/main/resources/mappings.json\n    ```\n    {\n      \"CLOUDANT_CONFIG\": \"{paste json here}\"\n    }\n    ```\n\n#### Implement the service\n\n1. Add a CloudantApi component to create the CloudantClient instance from the configuration\n\n    com.ibm.inventory_management.service.CloudServicesException\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    public class CloudServicesException extends Exception {\n        public CloudServicesException() {\n        }\n    \n        public CloudServicesException(String message) {\n            super(message);\n        }\n    \n        public CloudServicesException(String message, Throwable cause) {\n            super(message, cause);\n        }\n    \n        public CloudServicesException(Throwable cause) {\n            super(cause);\n        }\n    \n        public CloudServicesException(\n                String message,\n                Throwable cause,\n                boolean enableSuppression,\n                boolean writableStackTrace\n        ) {\n            super(message, cause, enableSuppression, writableStackTrace);\n        }\n    }\n    ```\n    \n    com.ibm.inventory_management.service.CloudantApi\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    import java.net.MalformedURLException;\n    import java.net.URL;\n    \n    import com.cloudant.client.api.ClientBuilder;\n    import com.cloudant.client.api.CloudantClient;\n    import org.springframework.context.annotation.Bean;\n    import org.springframework.stereotype.Component;\n    \n    import com.ibm.inventory_management.config.CloudantConfig;\n    \n    @Component\n    public class CloudantApi {\n        @Bean\n        public CloudantClient buildCloudant(CloudantConfig config) throws CloudServicesException {\n            System.out.println(\"Config: \" + config);\n            URL url = null;\n            try {\n                url = new URL(config.getUrl());\n            } catch (MalformedURLException e) {\n                throw new CloudServicesException(\"Invalid service URL specified\", e);\n            }\n    \n            return ClientBuilder\n                    .url(url)\n                    .username(config.getUsername())\n                    .password(config.getPassword())\n                    .build();\n        }\n    }\n    ```\n\n2. Add the service implementation\n\n    com.ibm.inventory_management.service.StockItemService\n    ```java\n    package com.ibm.inventory_management.service;\n    \n    import java.io.IOException;\n    import java.util.List;\n    import javax.annotation.PostConstruct;\n    \n    import com.cloudant.client.api.CloudantClient;\n    import com.cloudant.client.api.Database;\n    import org.springframework.context.annotation.Primary;\n    import org.springframework.stereotype.Service;\n    \n    import com.ibm.inventory_management.config.CloudantConfig;\n    import com.ibm.inventory_management.model.StockItem;\n    \n    @Service\n    @Primary\n    public class StockItemService implements StockItemApi {\n        private CloudantConfig config;\n        private CloudantClient client;\n        private Database db = null;\n    \n        public StockItemService(CloudantConfig config, CloudantClient client) {\n            this.config = config;\n            this.client = client;\n        }\n    \n        @PostConstruct\n        public void init() {\n            db = client.database(config.getDatabaseName(), true);\n        }\n    \n        @Override\n        public List<StockItem> listStockItems() throws Exception {\n    \n            try {\n                return db.getAllDocsRequestBuilder()\n                        .includeDocs(true)\n                        .build()\n                        .getResponse()\n                        .getDocsAs(StockItem.class);\n    \n            } catch (IOException e) {\n                throw new Exception(\"\", e);\n            }\n        }\n    }\n    ```\n\n3. Remove the `@Primary` annotation from the mock service\n\n#### Add the values to the helm chart\n\n1. Update the `cloudantBinding` and `databaseName` values in values.yaml\n\n    **Note:** The cloudantBinding value should match the name of the cloudant binding secret\n\n### Enable AppId on the application\n\n#### User Interface\n\n1. Update the `values.yaml` file in the chart to set `ingress.appId.enabled=true` and to set the value for the AppId binding secret\n\n```yaml\n...\nappidBinding: \"binding-sms-test-oc-appid\"\n\ningress:\n  enabled: true\n  appid:\n    enabled: true\n    # web or app - https://cloud.ibm.com/docs/services/appid?topic=appid-kube-auth\n    requestType: web\n    ...\n```\n\n#### AppId redirect url config\n\n1. When the UI application is available, navigate to the https url. An error page should be displayed that looks like the \nfollowing:\n    ![AppId redirect error](images/appid-redirect-error.png)\n    \n2. The url for the error page will look like the following: \n\n    `https://us-south.appid.cloud.ibm.com/oauth/v4/25d16cda-8899-46fa-a5ae-9818f93dd1d3/authorization?client_id=0351c750-a3f0-4b8c-818b-d14558f9dfb9&response_type=code&redirect_uri=https://inventory-manangement-ui-dev.sms-test-oc-cluster.us-east.containers.appdomain.cloud/appid_callback&scope=appid_default`\n    \n    Get the value of the `redirect_url` parameter.\n\n3. Open the IBM Cloud resource list - `https://cloud.ibm.com/resources` \n\n4. Open the AppId instance to the `Manage Authentication` -> `Authentication Settings`\n\n    ![AppId authentication settings](images/appid-authentication-settings.png)\n\n5. Add the `redirect_url` to the web redirect URLs\n\n#### Add users to AppId\n\n1. Open the AppId instance to `Cloud Directory` -> `Users`\n\n    ![AppId cloud directory users](images/appid-cloud-directory-users.png)\n\n2. Add users\n\n## Summary\n\nYou have now completed the Micro App Guide demonstrating the _Inventory_ solution.\n\n## Solution Links\n\nIf you want to skip the guide and just get the components running, here are the solution Git Repositories. You can clone these and `igc pipeline` them to register them in the CI pipeline. The **README.md** may include additional setup for populating test data etc.\n\n<AnchorLinks>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-ui\">Inventory Management User Interface</AnchorLink>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-bff\">Inventory Management Backend for Frontend</AnchorLink>\n  <AnchorLink to=\"https://github.com/ibm-garage-cloud/inventory-management-service\">Inventory Management Microservice</AnchorLink>\n</AnchorLinks>\n\n","fileAbsolutePath":"/Users/mjperrins/projects/cat/guide/src/pages/practical/inventory/index.mdx"}}}}